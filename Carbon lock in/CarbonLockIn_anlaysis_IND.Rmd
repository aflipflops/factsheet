---
title: "Carbon Lock-in task CD LINKS"
author: "Aman Malik and Chrstoph Bertram"
date: "17 September 2018"
output: html_document
---


```{r setup, include=FALSE}
# setting global settings for knitr
# echo=TRUE/FALSE whether to include R source code in the output file
# knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(fig.show = "hold",fig.path = "figure-carbonlockin/")
```


```{r message=FALSE, warning=FALSE, include=FALSE,results='hide'}
library(quitte)
library(moinput)
library(tidyr)
library(ggplot2)
library(readr)
library(dplyr)
library(tidyverse)
library(reshape)
library(data.table)
```

```{r echo=FALSE,results='hide',message=FALSE}

#read in data
# all <- invisible(fread("cdlinks_compare_20180508-032045.csv",header=TRUE)) #seems to be missing the V3 variants
# all <- invisible(fread("cdlinks_compare_20180810-010937.csv",header=TRUE)) #only MESSAGE
# all <- invisible(fread("cdlinks_compare_20180720-122848.csv",header=TRUE)) #only MESSAGE, AIM/CGE, IMAGE3.0, POLES, WITCH
all <- fread(input = "cdlinks_compare_20180615-153808.csv",header = T, sep = ',') #all V3 and V4 scens

#filter for desired set of time series
models <- unique(all$MODEL)
regions <- "IND" # unique(all$REGION)
scens <- unique(all$SCENARIO)
# How were these variables selected?
variables <- as.character(read.csv2("plotstyles_CLI.csv")$name)

all  <- all[all$MODEL %in% models & all$SCENARIO %in% scens & all$REGION %in% regions & all$VARIABLE %in% variables,]

all <- invisible(melt(all,measure.vars=names(all)[grep("[0-9]+",names(all))],variable.name = "period",variable.factor=FALSE))

all$period <- as.numeric(all$period)
all <- all[!period %in% c(1950,1955,1960,1965,1970,1975,1980,1985,1990,1995,2000,2001,2002,2003,2004,2006,2007,2008,2009,2011,2012,2013,2014,2016,2017,2018,2019,2021,2022,2023,2024,2026,2027,2028,2029,2031,2032,2033,2034,2036,2037,2038,2039,2041,2042,2043,2044,2046,2047,2048,2049,2051,2052,2053,2054,2056,2057,2058,2059,2061,2062,2063,2064,2066,2067,2068,2069,2071,2072,2073,2074,2076,2077,2078,2079,2081,2082,2083,2084,2086,2087,2088,2089,2091,2092,2093,2094,2096,2097,2098,2099,2101,2102,2103,2104,2106,2107,2108,2109)]
# Rename columns
setnames(all, "MODEL", "model")
setnames(all, "SCENARIO", "scenario")
setnames(all, "REGION", "region")
setnames(all, "VARIABLE", "variable")
setnames(all, "UNIT", "unit")

all  <- na.omit(all) # remove rows containing NAs

#make variables a factor, so that the order in facets can be manipulated easily
all$variable <- factor(all$variable)

all$model1 <- all$model
all$scenario1 <- all$scenario
all <- unite(all,col="modscen",c("model1","scenario1"),sep = " - ")
#make variables a factor, so that the order in facets can be manipulated easily
all$model <- factor(all$model)
all$scenario <- factor(all$scenario)
all$modscen <- factor(all$modscen)

#get rid of scenarios not interesting for us
scens_other <- c(grep("rec",unique(all$scenario),value=T),
                  grep("USD",unique(all$scenario),value=T),
              grep("Food",unique(all$scenario),value=T))
all <- all[!scenario %in% scens_other]

#get rid of V3 variants for models that have V4
v3scens <- grep("_V3",unique(all$scenario),value=T)
v4scens <- grep("_V4",unique(all$scenario),value=T)
v4mods <- unique(all[scenario %in% v4scens]$model)
all <- rbind(all[!model %in% v4mods],all[model %in% v4mods & scenario %in% v4scens])
fwrite(all,"")
save(all,file="data_IND.RData")
load("data_IND.RData")
```

### Explanation of scenario names

| Scenario name |  National Models | Global Models  |
|---------------|------------------|----------------|
|NPi2020_1000_V4 and NPi2020_1000_V3 | Extrapolating currently implemented national policies after 2020 till 2050  | Same as national models except extrapolation till 2100
|INDC2030i_1000_V4 and INDC2030i_1000_V3  | Extrapolating NDCs (includes currently implemented policies) after 2030 till 2050 |Same as national models except extrapolation till 2100
|NPi2020_low_V3 - **Early action**|Target for cumulative national emissions (budget) from 2011-2050|Target for cumulative global emissions from 2011-2100
|INDC2030_low_V3 - **Delay** | Same as Early action target|Same as Early action target
scenario

##### CO2 Emissions
```{r emissions, fig.asp=0.618}
# I want to remove the technical names of the scenarios and replace them with understandable names. Moreover, I want to preserve the bigger dataset and not break them into smaller datasets. Then I can plot emissions based on scenarios and models simultaneously.

# NPi Emissions
plot1 <- all[all$scenario %in% c("NPi2020_1000_V4","NPi2020_1000_V3"),]
plot1 <- add_column(plot1,scen_name = "NPi")
# NDC Emissions
plot1a <- all[all$scenario %in% c("INDC2030i_1000_V4","INDC2030i_1000_V3"),]
plot1a <-  add_column(plot1a,scen_name = "NDC")
# Early and Delay scenarios
plot2a <- all[all$scenario %in% "NPi2020_low_V3",]
plot2a <- add_column(plot2a,scen_name = "Early action")
plot2b <- all[all$scenario %in% "INDC2030_low_V3",]
plot2b <- add_column(plot2b,scen_name = "Delayed action")
whole <- rbind(plot1,plot1a,plot2a,plot2b)
```

```{r}
#plot emissions lines
plotvar <- "Emissions|CO2"
whole_a <- whole[variable==plotvar,]
# historical emissions //India// Fossil Fuel and Industry
setConfig(forcecache = T)
historical <- calcOutput("Historical",aggregate = F)
# all variables of interest, containing term "Emi|CO2"
namesofint <- getNames(historical[,,"Emi|CO2",pmatch=T])
hist_ind <- as.data.frame(historical["IND",seq(2005,2010,5),namesofint[20]]/1000)

ggplot()+
  geom_line(data = whole_a,aes(x=period,y=value/1000,group=interaction(model,scen_name),color=model,linetype=scen_name)) +
  labs(
    x = "Year" ,
    y = "CO2 Emissions of India (Gt/yr)",
    color = "Model name",
    linetype = "Scenario Type"
  ) +
  coord_cartesian(xlim = c(2005,2050),ylim=c(0,8)) +
  annotate(geom = "point",x = c(2005,2010),y=hist_ind$Value)+
  # scale_colour_brewer(palette = "Set1")+
  theme_light()
  ggsave(file="CO2emi_IND_all_scen.png",width=8,height=4)
```


#### Emissions from the Electricity sector
```{r}
#plot emissions electricity sector 
plotvar <- "Emissions|CO2|Energy|Supply|Electricity"
whole_b <- whole[variable==plotvar,]
hist_ind <- as.data.frame(historical["IND",seq(2005,2015,5),namesofint[16]]/1000)

ggplot()+
  geom_line(data = whole_b,aes(x=period,y=value/1000,group=interaction(model,scen_name),color=model,linetype=scen_name)) +
  labs(
    x = "Year" ,
    y = "CO2 Emissions Electricity (Gt/yr)",
    color = "Model name",
    linetype = "Scenario Type"
  ) +
  coord_cartesian(xlim = c(2005,2050),ylim=c(-0.5,2.5)) +
  annotate(geom = "point",x = c(2005,2010,2015),y=hist_ind$Value)+
  # scale_colour_brewer(palette = "Set1")+
  theme_light()
  ggsave(file="CO2emi_elec_IND.png",width=8,height=4)
```

#### Final Energy of Electricity
```{r}
plotvar <- "Final Energy|Electricity"
whole_c <- whole[variable==plotvar,]
hist_ind <- as.data.frame(historical["IND",c(2005,2010),"historical.IEA.FE|Electricity (EJ/yr)"])
ggplot()+
  geom_line(data = whole_c,aes(x=period,y=value,group=interaction(model,scen_name),color=model,linetype=scen_name)) +
  labs(
    x = "Year" ,
    y = "Final Energy Electricity (EJ/yr)",
    color = "Model name",
    linetype = "Scenario Type"
  ) +
  coord_cartesian(xlim = c(2005,2050),ylim=c(0,30)) +
  annotate(geom = "point",x = c(2005,2010),y=hist_ind$Value)+
  # scale_colour_brewer(palette = "Set1")+
  theme_light()
  ggsave(file="FEelec_IND.png",width=8,height=4)
```

#### Capital Cost
```{r}
#plot capital cost
plotvar <- "Capital Cost|Electricity|Solar|PV"
whole_d <- whole[variable==plotvar,]
localrate = 0.015 #https://www.xe.com/currencycharts/?from=INR&to=USD&view=10Y
whole_d[model %in% c("India MARKAL","AIM/Enduse 3.0"),]$value <- whole_d[model %in% c("India MARKAL","AIM/Enduse 3.0"),]$value*localrate

ggplot()+
  geom_line(data = whole_d,aes(x=period,y=value,group=interaction(model,scen_name),color=model)) +
  labs(
    x = "Year" ,
    y = "Tech Cost PV ($/W)",
    color = "Model name",
    linetype = "Scenario Type"
  ) +
  coord_cartesian(xlim = c(2005,2050)) +
  # scale_colour_brewer(palette = "Set1")+
  theme_light()
ggsave(file="CapCostPV_IND.png",width=8,height=4)
```

#### Secondary Energy from Coal 
```{r}
plotvar <- "Secondary Energy|Electricity|Coal|w/o CCS"
whole_e <- whole[variable==plotvar,]    
hist_ind <- as.data.frame(historical["IND",c(2005,2010),"historical.IEA.SE|Electricity|Coal (EJ/yr)"])
hist_ind$Year <-as.numeric(as.character(hist_ind$Year))
ggplot()+
  geom_line(data = whole_e,aes(x=period,y=value,group=interaction(model,scen_name),color=model)) +
  labs(
    x = "Year" ,
    y = "Unabated Coal Power (EJ/yr)",
    color = "Model name",
    linetype = "Scenario Type"
  ) + 
  coord_cartesian(xlim = c(2005,2050)) +
  # geom_point(data=hist_ind,aes(x = Year,y = Value),color=Value)+
  annotate(geom = "point",x = c(2005,2010),y=hist_ind$Value)+
  # scale_colour_brewer(palette = "Set1")+
  theme_light()
ggsave(file="UnabatedCoal_IND.png",width=8,height=4)
```
#### Coal Power Capacity
```{r}
#plot Coal power capacity
plotvar <- "Capacity|Electricity|Coal|w/o CCS"
whole_f <- whole[variable==plotvar,]    

ggplot()+
  geom_line(data = whole_f,aes(x=period,y=value,group=interaction(model,scen_name),color=model)) +
  labs(
    x = "Year" ,
    y = "Unabated Coal Power (GW)",
    color = "Model name",
    linetype = "Scenario Type"
  ) +
  coord_cartesian(xlim = c(2005,2050)) +
  # scale_colour_brewer(palette = "Set1")+
  theme_light()
ggsave(file="UnabatedCoalGW_IND.png",width=8,height=4)
```


```{r}
#Power generation in 2030
plotvar <- c("Secondary Energy|Electricity|Biomass|w/ CCS",
             "Secondary Energy|Electricity|Biomass|w/o CCS",
             "Secondary Energy|Electricity|Coal|w/ CCS",
             "Secondary Energy|Electricity|Coal|w/o CCS",
             "Secondary Energy|Electricity|Gas|w/ CCS",
             "Secondary Energy|Electricity|Gas|w/o CCS",
             "Secondary Energy|Electricity|Geothermal",
             "Secondary Energy|Electricity|Hydro",
             "Secondary Energy|Electricity|Nuclear",
             "Secondary Energy|Electricity|Ocean",
             "Secondary Energy|Electricity|Oil",
             "Secondary Energy|Electricity|Other",
             "Secondary Energy|Electricity|Solar",
             "Secondary Energy|Electricity|Wind")

whole_g <-whole[variable %in% plotvar & period==2030,]
whole_h <- whole[variable %in% "Secondary Energy|Electricity" & period==2030,]

source("plotstyle.R")

ggplot()+
  geom_bar(data = whole_g,aes(x=modscen,y=value,group=interaction(model,variable),fill=variable),stat="identity") +
  scale_fill_manual(values=plotstyle(plotvar))  + xlab("Model - Scenario")+
  geom_text(data=whole_g,aes(x=modscen,y=25,label=modscen,angle=90,hjust="right"),color="red",size=2.5)+
  geom_point(data=whole_f,aes(x=modscen,y=value))+ylim(0,25)+
  theme_bw()+ylab("Secondary Energy Electricity (EJ/yr)")
```


# Power capacity in 2030
```{r}
#Power capacity in 2030
plotvar <- c("Capacity|Electricity|Biomass|w/ CCS",
             "Capacity|Electricity|Biomass|w/o CCS",
             "Capacity|Electricity|Coal|w/ CCS",
             "Capacity|Electricity|Coal|w/o CCS",
             "Capacity|Electricity|Gas|w/ CCS",
             "Capacity|Electricity|Gas|w/o CCS",
             "Capacity|Electricity|Geothermal",
             "Capacity|Electricity|Hydro",
             "Capacity|Electricity|Nuclear",
             "Capacity|Electricity|Ocean",
             "Capacity|Electricity|Oil",
             "Capacity|Electricity|Other",
             "Capacity|Electricity|Solar",
             "Capacity|Electricity|Wind")

plot1 <- all[scenario %in% c("NPi2020_1000_V4","NPi2020_1000_V3", "INDC2030i_1000_V4","INDC2030i_1000_V3",
                             "NPi2020_low_V3","INDC2030_low_V3") & variable %in% plotvar & period==2030]

plot1a <- all[scenario %in% c("NPi2020_1000_V4","NPi2020_1000_V3", "INDC2030i_1000_V4","INDC2030i_1000_V3",
                             "NPi2020_low_V3","INDC2030_low_V3") & period==2030 & 
               variable %in% "Capacity|Electricity|Solar|PV" &
                model %in% c("AIM V2.1","AIM/CGE","DNE21+ V.14", "REMIND-MAgPIE 1.7-3.0")]
plot1a$variable <- "Capacity|Electricity|Solar"

plot1b <- all[scenario %in% c("NPi2020_1000_V4","NPi2020_1000_V3", "INDC2030i_1000_V4","INDC2030i_1000_V3",
                              "NPi2020_low_V3","INDC2030_low_V3") & period==2030 & 
                variable %in% "Capacity|Electricity|Wind|Onshore" &
                model %in% c("DNE21+ V.14")]
plot1b$variable <- "Capacity|Electricity|Wind"

plot1 <- rbind(plot1,plot1a,plot1b)

plot2 <- all[scenario %in% c("NPi2020_1000_V4","NPi2020_1000_V3", "INDC2030i_1000_V4","INDC2030i_1000_V3",
                             "NPi2020_low_V3","INDC2030_low_V3") & period==2030 & 
               variable %in% "Capacity|Electricity" ]
ggplot()+
  geom_bar(data=plot1,aes(x=modscen,y=value/1,group=interaction(modscen,variable),fill=variable),stat="identity")+
  scale_fill_manual(values=plotstyle(plotvar))  + xlab("Model - Scenario")+
  geom_text(data=plot1,aes(x=modscen,y=1300,label=modscen,angle=90,hjust="right"),color="red",size=2.5)+
  geom_point(data=plot2,aes(x=modscen,y=value))+ylim(0,1300)+
  theme_bw()+ylab("Power Capacity (GW)")
ggsave(file="Capacity_IND.png",width=8,height=5)

```