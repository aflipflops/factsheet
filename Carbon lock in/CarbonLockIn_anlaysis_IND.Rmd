
---
title: "Carbon Lock-in task CD LINKS"
author: "Aman Malik and Christoph Bertram"
date:   "15 October 2018"  
output: 
html_document:
  toc: true
  toc_depth: 2
pdf_document:
    keep_tex: true
---

```{r global settings, include=FALSE}
# setting global settings for knitr
# echo=TRUE/FALSE whether to include R source code in the output file
# knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(fig.path = "figure-carbonlockin/",cache = T,echo=F)
```

```{r comments knitr}
#### Some comments on knitr arguments ########
#warnings=FALSE, switches off all warnings from the trunk
#eval = FALSE, doesn't evaluate the chunk. Useful for packages that are not yet open-source, e.g., moinput
# include=FALSE, suppresses messages associated with loading packages
```

```{r req packages,message=FALSE, warning=FALSE, include=FALSE,results='hide'}
# library(quitte)
# library(moinput)
library(tidyverse)
library(reshape)
library(data.table)
library(RColorBrewer)
```

```{r all_data,include=FALSE,eval=FALSE,message=FALSE,purl=FALSE}
#read in data
# all <- invisible(fread("cdlinks_compare_20180508-032045.csv",header=TRUE)) #seems to be missing the V3 variants
# all <- invisible(fread("cdlinks_compare_20180810-010937.csv",header=TRUE)) #only MESSAGE
# all <- invisible(fread("cdlinks_compare_20180720-122848.csv",header=TRUE)) #only MESSAGE, AIM/CGE, IMAGE3.0, POLES, WITCH
all <- fread(input = "cdlinks_compare_20180615-153808.csv",header = T, sep = ',') #all V3 and V4 scens

#filter for desired set of time series
models <- unique(all$MODEL)
regions <- "IND" # unique(all$REGION)
scens <- unique(all$SCENARIO)
# How were these variables selected?
# variables <- as.character(read.csv2("plotstyles_CLI.csv")$name)
variables <- grep("Diagnostics",unique(all$VARIABLE),value=T,fixed = T)

all  <- all[all$MODEL %in% models & all$SCENARIO %in% scens & all$REGION %in% regions & !(all$VARIABLE %in% variables),]

all <- invisible(melt(all,measure.vars=names(all)[grep("[0-9]+",names(all))],variable.name = "period",variable.factor=FALSE))
all$period <- as.numeric(all$period)

all <- all[!period %in% c(1950,1955,1960,1965,1970,1975,1980,1985,1990,1995,2000,2001,2002,2003,2004,2006,2007,2008,2009,2011,2012,2013,2014,2016,2017,2018,2019,2021,2022,2023,2024,2026,2027,2028,2029,2031,2032,2033,2034,2036,2037,2038,2039,2041,2042,2043,2044,2046,2047,2048,2049,2051,2052,2053,2054,2056,2057,2058,2059,2061,2062,2063,2064,2066,2067,2068,2069,2071,2072,2073,2074,2076,2077,2078,2079,2081,2082,2083,2084,2086,2087,2088,2089,2091,2092,2093,2094,2096,2097,2098,2099,2101,2102,2103,2104,2106,2107,2108,2109)]
# Rename columns
setnames(all, "MODEL", "model")
setnames(all, "SCENARIO", "scenario")
setnames(all, "REGION", "region")
setnames(all, "VARIABLE", "variable")
setnames(all, "UNIT", "unit")

all  <- na.omit(all) # remove rows containing NAs

#make variables a factor, so that the order in facets can be manipulated easily
all$variable <- factor(all$variable)


all$model1 <- all$model
all$scenario1 <- all$scenario
all <- unite(all,col="modscen",c("model1","scenario1"),sep = " - ")
#make variables a factor, so that the order in facets can be manipulated easily
all$model <- factor(all$model)
all$scenario <- factor(all$scenario)
all$modscen <- factor(all$modscen)

#get rid of scenarios not interesting for us
scens_other <- c(grep("rec",unique(all$scenario),value=T),
                  grep("USD",unique(all$scenario),value=T),
              grep("Food",unique(all$scenario),value=T))
all <- all[!scenario %in% scens_other]

#get rid of V3 variants for models that have V4
v3scens <- grep("_V3",unique(all$scenario),value=T)
v4scens <- grep("_V4",unique(all$scenario),value=T)
v4mods <- unique(all[scenario %in% v4scens]$model)
all <- rbind(all[!model %in% v4mods],all[model %in% v4mods & scenario %in% v4scens])

all <- all %>% 
  filter(model!="GLOBIOM 1.0" )%>%
  mutate(model_scope=ifelse(model=="India MARKAL"|model=="AIM/Enduse 3.0","national","global"))
# Early scenario
early <- all[all$scenario %in% c("NPi2020_1000_V4","NPi2020_1000_V3","NPi2020_low_V3"),]
early <- add_column(early,scen_name = "Early action")
# Delay scenario
delay   <- all[all$scenario %in% c("INDC2030i_1000_V4","INDC2030i_1000_V3","INDC2030_low_V3"),]
delay <-  add_column(delay,scen_name = "Delayed action")
whole <- rbind(early,delay)
fwrite(whole,"")
save(whole,file="data_IND_2.RData")
```
```{r,echo=FALSE}
# load("data_IND.RData")
load("data_IND_2.RData")# with all variables except diagnostics
whole <- whole %>% 
  filter(!model=="COPPE-COFFEE 1.0")
```


```{r historical data,include=FALSE,eval=FALSE}
# Relevant historical and bottom-up data 
# historical IEA data (PE, SE, FE,Trade), and CEDS emissions data
setConfig(forcecache = TRUE)
historical <- calcOutput("Historical",aggregate = F)# aggregate = T not working at the moment, use when available
historical <- collapseNames(historical,collapsedim = 1)
hist_IEA_CEDS <- as.data.frame(historical) 
hist_IEA_CEDS <- hist_IEA_CEDS[,-1]
# Format "Region"   "Year"  "Source"   "Variable" "Value"
names(hist_IEA_CEDS)[c(3,4)] <- c("Source","Variable")
# historical Renewable Energy Capacity data 
hist_IRENA_cap <- as.data.frame(calcOutput("Capacity",aggregate = T))
hist_IRENA_cap <- hist_IRENA_cap[,-1]
hist_IRENA_cap$Source <- "IRENA"
hist_IRENA_cap <- hist_IRENA_cap[,c(1,2,5,3,4)]
names(hist_IRENA_cap) <- names(hist_IEA_CEDS)

# nuclear bottom-up data
nuclear_IAEA <- as.data.frame(calcOutput("CapacityNuclear",aggregate = T))
nuclear_IAEA <- nuclear_IAEA[,-1]
nuclear_IAEA$Source <- "IEA"
nuclear_IAEA <- nuclear_IAEA[,c(1,2,5,3,4)]
names(nuclear_IAEA) <- names(hist_IEA_CEDS)
# coal plants bottom up data
coal_EndCoal <- as.data.frame(readSource("EndCoal"))
coal_EndCoal <- coal_EndCoal[,-1]
coal_EndCoal$Year <- "2018"
coal_EndCoal$Source <- "EndCoal"
coal_EndCoal <- coal_EndCoal[,c(1,2,5,3,4)]
names(coal_EndCoal) <- names(hist_IEA_CEDS)
# coal_EndCoal$Value <- as.character(coal_EndCoal$Value)
# IEA_WEO 2016 investment costs
capacity_costs_IEA <- as.data.frame(calcOutput("DiffInvestCosts",aggregate = T))
capacity_costs_IEA <- capacity_costs_IEA[,-1]
capacity_costs_IEA$Source <- "IEA_WEO"
capacity_costs_IEA <- capacity_costs_IEA[,c(1,2,5,3,4)]
names(capacity_costs_IEA) <- names(hist_IEA_CEDS)

# bringing all historical and bottom up data together; format- region, Variable Name, Year, Value
hist_and_botmup <- rbind(hist_IEA_CEDS,hist_IRENA_cap,nuclear_IAEA,capacity_costs_IEA,coal_EndCoal)   


# historical nuclear 
save(hist_and_botmup,file="HistandBotmup.RData")
```

```{r}
load("HistandBotmup.RData")
```

### Objective
The objective of the current task is to analyse and compare the structure of the Indian power sector under various mitigation regimes. It is often said that models are as good as the assumptions they are based on. 
The primary one would be to understand what consequences follow from certain assumptions. Or the other way round, which assumptions are causing the divergent behaviour. The secondary aim is to comment upon the plausibility of the assumptions used by these models. 

### Methodology

Global Integrated Assessment Models (IAMs) informed national energy-economy models and national IAMs in terms of national emission budgets consistent with long-term climate targets. National models often focus on nation-specific development issues, and have a stronger grasp on technologies and policies. Indian budgets were defined as they are because the national teams said they cannot produce scenarios with lower budgets.

#### Explanation of scenario names

| Scenario name |  National Models | Global Models  |
|---------------|------------------|----------------|
|Early action|Cumulative national emissions (budget/target) from 2011-2050, climate policy starts in 2020|Cumulative global emissions target of 1000GtC, climate policy starts in 2020|
|Delayed action|Cumulative national emissions (budget/target) from 2011-2050, climate policy starts in 2030|Cumulative global emissions target of 1000GtC, climate policy starts in 2030|

```{r generic plot functions}

myColors <- brewer.pal(11,"Paired")
#myColors <- rainbow_hcl(12)
names(myColors) <- as.character(unique(whole$model))

# Writing a generic function for a line-type ggplot
line_type_1 <- function(data_s,hist_s){
  ggplot()+
  geom_line(data = data_s , aes(x=period,y=value,group=interaction(model,scen_name),linetype=scen_name,color=model_scope)) +
   labs(
    x = "Year" ,
    y = paste(data_s$variable,"(",data_s$unit,")"),
    color = "Model Scope",
    linetype = "Scenario Type"
  ) +
  theme_bw()+ 
    coord_cartesian(xlim = c(2005,2050),ylim =c(1.3*min(data_s$value[data_s$period<2050]),1.3*max(data_s$value[data_s$period<2050])))+
     annotate(geom = "point",x = as.numeric(as.character(hist_s$Year)),y=hist_s$Value)
  # ggsave(file=paste(gsub(c("\\||\\/"),"_",unique(data_s$variable)),"_1",".png",sep=""))
}

line_type_2 <- function(data_s,hist_s){
  ggplot()+
  geom_line(data = data_s %>% filter(model %in% c("India MARKAL","AIM/Enduse 3.0")), aes(x=period,y=value,group=interaction(model,scen_name),linetype=scen_name,alpha=model),size=1.5) +
geom_line(data = data_s %>% filter(!model %in% c("India MARKAL","AIM/Enduse 3.0"),period<2051), aes(x=period,y=value,group=interaction(model,scen_name),color=model,linetype=scen_name),size=1)+
    labs(
    x = "Year" ,
    y = paste(data_s$variable,"(",data_s$unit,")"),
    color = "Global Model",
    alpha="National Model",
    linetype = "Scenario Type")+
  theme_bw()+ 
  coord_cartesian(xlim = c(2005,2050),ylim =c(1.3*min(data_s$value[data_s$period<2050]),1.3*max(data_s$value[data_s$period<2050])))+
  scale_colour_manual(values = myColors)+
  # scale_colour_brewer(palette = "Set1")+
  scale_alpha_discrete(range = c(0.95, 0.60))+
    geom_point(data = hist_s,aes(x = as.numeric(as.character(Year)),y=Value),colour = "black",size=2.5,shape=17,color="white")
 
  # ggsave(file=paste(gsub(c("\\||\\/"),"_",unique(data_s$variable)),"_2",".png",sep=""))
  }

```

## Results and Discussion

### CO2 Emissions
#### Energy sector CO2 emissions
```{r co2 energy emissions,fig.show='hold',out.width="50%",warning=FALSE}
########## DATA
whole_emi <- whole[whole$variable=="Emissions|CO2|Energy",]
# Finding the min and max values for each time-step
whole_emi_m <- whole_emi %>% 
  filter(period<2051) %>% 
  group_by(period,model_scope) %>% 
  summarise(minimum=min(value),maximum=max(value))


# historical emissions //India// Fossil Fuel and Industry
hist_emi <- hist_and_botmup %>% filter(Region=="IND", Year %in% c(2005:2015),Variable =="Emi|CO2|Energy (Mt CO2/yr)") 



####### PLOT
#line_type_1(whole_emi,hist_emi)
line_type_2(whole_emi,hist_emi)+
  geom_ribbon(data = whole_emi_m %>% filter(model_scope=="global"),aes(x =period,ymin = minimum,ymax=maximum),alpha = 0.1,fill="blue")+
geom_ribbon(data = whole_emi_m %>% filter(model_scope=="national"),aes(x = period,ymin = minimum,ymax=maximum),alpha = 0.1,fill="orange")
  



```


#### Electricity sector emissions
```{r co2 electricity emissions,fig.show='hold',out.width="50%",warning=FALSE}
########### DATA
whole_emi_elec <- whole[whole$variable=="Emissions|CO2|Energy|Supply|Electricity",]

whole_emi_elec_m <- whole_emi_elec %>% 
  filter(period<2051) %>% 
  group_by(period,model_scope) %>% 
  summarise(minimum=min(value),maximum=max(value))

# historical emissions //India// Fossil Fuel and Industry
hist_emi_elec <- hist_and_botmup %>% filter(Region=="IND", Year %in% c(2005:2015),Variable =="Emi|CO2|Energy|Supply|Electricity (Mt CO2/yr)") 

########## PLOT
#line_type_1(whole_emi_elec,hist_emi_elec)
line_type_2(whole_emi_elec,hist_emi_elec)+
  geom_ribbon(data = whole_emi_elec_m %>% filter(model_scope=="global"),aes(x =period,ymin = minimum,ymax=maximum),alpha = 0.1,fill="blue")+
geom_ribbon(data = whole_emi_elec_m %>% filter(model_scope=="national"),aes(x = period,ymin = minimum,ymax=maximum),alpha = 0.1,fill="orange")
```

#### Share of electricity emissions to energy emissions
```{r co2 share of elec_emissions,fig.show='hold',out.width="50%",warning=FALSE}
######### DATA
whole_emi <- whole_emi %>% 
  filter(period<=2050) %>% 
  arrange(modscen)

whole_emi_elec_share <- whole_emi_elec %>% 
  filter(period<=2050,!modscen %in% c("WITCH2016 - NPi2020_1000_V4", "WITCH2016 - INDC2030i_1000_V4")) %>% 
  arrange(modscen) %>% 
  mutate(share=value/whole_emi$value) 
  

whole_emi_elec_share$variable <- "Emissions|CO2|Energy|Supply|Electricity|Share"
whole_emi_elec_share$unit <- ""
whole_emi_elec_share$value <- whole_emi_elec_share$share
hist_emi_elec_share <- hist_emi_elec %>% 
  mutate(share=hist_emi_elec$Value/hist_emi$Value)
hist_emi_elec_share$Value <- hist_emi_elec_share$share


whole_emi_elec_share_m <- whole_emi_elec_share %>% 
  filter(period<2051) %>% 
  group_by(period,model_scope) %>% 
  summarise(minimum=min(value),maximum=max(value))


########## PLOT
line_type_2(whole_emi_elec_share,hist_emi_elec_share)+
  coord_cartesian(ylim=c(0.75,0))+
  geom_ribbon(data = whole_emi_elec_share_m %>% filter(model_scope=="global"),aes(x =period,ymin = minimum,ymax=maximum),alpha = 0.1,fill="blue")+
geom_ribbon(data = whole_emi_elec_share_m %>% filter(model_scope=="national"),aes(x = period,ymin = minimum,ymax=maximum),alpha = 0.1,fill="orange")


```

#### Cumulative Emissions 2011-2050
```{r cum_emi,warning=FALSE}
### DATA 
whole_cum <- whole_emi %>% 
  filter(period>2010 & period<2055) %>% 
  group_by(model,scen_name) %>% 
  mutate(cumsum=cumsum(value)/1000) %>% 
  arrange(cumsum,desc(cumsum))


ggplot()+
  geom_bar(data=whole_cum %>% filter(period==2030) , aes(x=model,y=value, group=interaction(model,scen_name),fill=scen_name),position="dodge", stat = "identity")+
  labs(
    x = "Model name" ,
    y = "Final Energy of electricity in 2030",
    fill = "Scenario Type",
    alpha = "Model Scope"
  ) +
  # theme_bw()+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))+
  #scale_alpha_discrete(range = c(0.95, 0.55))
  facet_grid(~model_scope,scales="free",space = "free_x")


```

### Secondary Energy of Electricity
```{r Secondary Energy,warning=FALSE,fig.show='hold',out.width="50%"}
plotvar_1 <- c("Secondary Energy|Electricity|Biomass|w/ CCS",
             "Secondary Energy|Electricity|Biomass|w/o CCS",
             "Secondary Energy|Electricity|Other",
             "Secondary Energy|Electricity|Geothermal",
             "Secondary Energy|Electricity|Ocean",
             "Secondary Energy|Electricity|Oil",
             "Secondary Energy|Electricity|Hydro",
             "Secondary Energy|Electricity|Nuclear",
             "Secondary Energy|Electricity|Solar",
             "Secondary Energy|Electricity|Wind",
             "Secondary Energy|Electricity|Gas|w/ CCS",
             "Secondary Energy|Electricity|Gas|w/o CCS",
             "Secondary Energy|Electricity|Coal|w/ CCS",
             "Secondary Energy|Electricity|Coal|w/o CCS")
#### only important fuels
plotvar_2 <- c("Secondary Energy|Electricity|Biomass|w/ CCS",
             "Secondary Energy|Electricity|Biomass|w/o CCS",
             "Secondary Energy|Electricity|Hydro",
             "Secondary Energy|Electricity|Nuclear",
             "Secondary Energy|Electricity|Solar",
             "Secondary Energy|Electricity|Wind",
             "Secondary Energy|Electricity|Gas|w/ CCS",
             "Secondary Energy|Electricity|Gas|w/o CCS",
             "Secondary Energy|Electricity|Coal|w/ CCS",
             "Secondary Energy|Electricity|Coal|w/o CCS")
#whole_se_elec <- whole %>% filter(variable %in% plotvar_1 )
whole_se_elec <- whole %>% filter(variable %in% plotvar_1)


### Total Secondary Energy of Electricity by adding all SE techs
whole_se_elec_sum <- whole_se_elec %>% 
  group_by(model, scenario,unit, period,modscen, model_scope, scen_name) %>% 
  summarise(value=sum(value)) %>% 
  mutate(variable="Secondary Energy|Electricity")


# Historical SE 
 hist_se_elec_var <- c( "SE|Electricity|Biomass (EJ/yr)",    
    "SE|Electricity|Coal (EJ/yr)" ,      
    "SE|Electricity|Gas (EJ/yr)"    ,    
  "SE|Electricity|Geothermal (EJ/yr)",  "SE|Electricity|Hydro (EJ/yr)" ,     
"SE|Electricity|Oil (EJ/yr)"       ,  "SE|Electricity|Solar (EJ/yr)" ,     
 "SE|Electricity|Nuclear (EJ/yr)"   ,  "SE|Electricity|Wind (EJ/yr)"    )   
hist_se_elec <- hist_and_botmup %>% filter(Region=="IND", Year %in% c(2005:2015), Variable %in% hist_se_elec_var)
# summing up
hist_se_elec_sum <- hist_se_elec %>% 
  group_by(Region,Year) %>% 
  summarise(Value=sum(Value))

#line_type_1(whole_se_elec_sum,hist_se_elec_sum)
line_type_2(whole_se_elec_sum,hist_se_elec_sum)
```


#### Secondary Energy coal
```{r SE_coal}
# SE|Coal|Electricity
whole_se_elec_coal <- whole %>% filter(variable=="Secondary Energy|Electricity|Coal")

hist_se_elec_coal <- hist_and_botmup %>% filter(Region=="IND", Year %in% c(2005:2015),
                    Variable=="SE|Electricity|Coal (EJ/yr)")
source("plotstyle.R")

ggplot()+
  geom_line(data = whole %>% filter(period<2050,variable=="Secondary Energy|Electricity|Coal|w/o CCS") , aes(x=period,y=value,group=interaction(model,scen_name),linetype=model_scope,color=model,size=0.8))+facet_grid(~scen_name)+
 labs(
    x = "Year",
    y = "Secondary Energy|Electricity|Coal (EJ/yr)"
    )+ theme_bw()+
   annotate("point",x=c(2005:2015),y=hist_se_elec_coal$Value)+scale_color_manual(values = myColors)
```

#### Seconday Energy gas
```{r SE_gas}
# SE|Gas|Electricity
whole_se_elec_gas <- whole %>% filter(variable=="Secondary Energy|Electricity|Gas")

hist_se_elec_gas <- hist_and_botmup %>% filter(Region=="IND", Year %in% c(2005:2015), Variable=="SE|Electricity|Gas (EJ/yr)")

ggplot()+
  geom_line(data = whole %>% filter(period<2050,variable=="Secondary Energy|Electricity|Gas") , aes(x=period,y=value,group=interaction(model,scen_name),linetype=model_scope,color=model))+facet_grid(~scen_name)+
 labs(
    x = "Year",
    y = "Secondary Energy|Electricity|Gas (EJ/yr)" )+ theme_bw()+
   annotate("point",x=c(2005:2015),y=hist_se_elec_gas$Value)+
  scale_color_manual(values = myColors)

source("plotstyle.R")

```


#### Secondary Energy by all sources 
```{r SE by source}


##### ABSOLUTE SE
####### BAR PLOTS
#### FOR 2030 and 2050
ggplot(data=whole_se_elec %>% filter(period %in% c(2030,2050)))+
  geom_bar(aes(x=as.factor(period),y=value,group=variable,fill=variable),position = position_stack(),stat = "identity")+
    scale_fill_manual(values=plotstyle(plotvar_1))+
  facet_grid(scen_name~model)+
    theme(strip.text.x = element_text(angle = 90,size = 8),axis.text.x = element_text(angle = 90, hjust = 1))+
  labs(
    x="Period",
    y = "Secondary Energy (EJ/yr)")
#### ONLY FOR 2030
ggplot()+
  geom_bar(data=whole_se_elec %>% filter(period==2030) , aes(x=scen_name,y=value,group=variable,fill=variable),position = "stack",stat = "identity")+scale_fill_manual(values=plotstyle(plotvar_1))+
  facet_grid(scen_name~model)+
    theme(strip.text.x = element_text(angle = 90,size = 8),axis.text.x = element_text(angle = 90, hjust = 1))+
  labs(
    x="Scenario",
    y = "Secondary Energy (EJ/yr) in 2030")
#### ONLY for 2050
ggplot()+
  geom_bar(data=whole_se_elec %>% filter(period==2050) , aes(x=scen_name,y=value,group=variable,fill=variable),position = "stack",stat = "identity")+scale_fill_manual(values=plotstyle(plotvar_1))+
  facet_grid(scen_name~model)+
    theme(strip.text.x = element_text(angle = 90,size = 8),axis.text.x = element_text(angle = 90, hjust = 1))+
  labs(
    x="Scenario",
    y = "Secondary Energy (EJ/yr) in 2050")

##### SE SHARES
ggplot(data=whole_se_elec %>% filter(period %in% c(2030)))+
  geom_bar(aes(x=as.factor(period),y=value,group=variable,fill=variable),position = "fill",stat = "identity")+
    scale_fill_manual(values=plotstyle(plotvar_1))+
  facet_grid(scen_name~model)+
    theme(strip.text.x = element_text(angle = 90,size = 8),axis.text.x = element_text(angle = 90, hjust = 1))+
  labs(x="Period",
    y = "Secondary Energy shares in 2030")


### SEPERATING NATIONAL AND GLOBAL
ggplot()+
  geom_bar(data=whole_se_elec %>% filter(period %in% c(2030),model_scope=="national"),aes(x=as.factor(period),y=value,group=variable,fill=variable),position = "fill",stat = "identity",color="red",stroke = 2)+
    scale_fill_manual(values=plotstyle(plotvar_1))+
  facet_grid(scen_name~model)+
    theme(strip.text.x = element_text(angle = 90,size = 8),axis.text.x = element_text(angle = 90, hjust = 1))+
  labs(x="Period",
    y = "Secondary Energy shares in 2030")+
    geom_bar(data=whole_se_elec %>% filter(period %in% c(2030),model_scope=="global"),aes(x=as.factor(period),y=value,group=variable,fill=variable),position = "fill",stat = "identity")+
    scale_fill_manual(values=plotstyle(plotvar_1))+
  facet_grid(scen_name~model)
    


```


### Final Energy of Electricity
```{r Final energy,message=FALSE,warning=FALSE}
######### DATA
# FE
whole_fe_elec <- whole %>% filter(variable=="Final Energy|Electricity")

# Historical FE
hist_fe_elec <- hist_and_botmup %>% filter(Region=="IND", Year %in% c(2005:2015),Variable =="FE|Electricity (EJ/yr)") 

############ PLOTS
#### BAR PLOT
ggplot()+
  geom_bar(data=whole_fe_elec %>% filter(period==2030) , aes(x=scen_name,y=value,group=variable),position = "stack",stat = "identity")+scale_fill_manual(values=plotstyle(plotvar_1))+
  facet_grid(~model)+
    theme(strip.text.x = element_text(angle = 90,size = 8),axis.text.x = element_text(angle = 90, hjust = 1))+
  labs(
    x="Scenario",
    y = "Final Energy (EJ/yr) in 2030")

#### LINE PLOT
#line_type_1(whole_fe_elec,hist_fe_elec)
line_type_2(whole_fe_elec,hist_fe_elec)

```


#### Final Energy by sector
```{r FE by sector,message=FALSE,warning=FALSE}

var_fe <- c("Final Energy|Residential and Commercial|Electricity" ,  "Final Energy|Industry|Electricity",  "Final Energy|Other Sector|Electricity","Final Energy|Transportation|Electricity" )
whole_fe_elec_1 <- whole %>% filter(variable %in% var_fe,period<2051)

# whole_fe_elec_1$variable <- shorten_legend(whole_fe_elec_1$variable)
ggplot()+ 
geom_line(data = whole_fe_elec_1 %>% filter(model %in% c("India MARKAL","AIM/Enduse 3.0")), aes(x=period,y=value,group=interaction(model,scen_name),linetype=scen_name,alpha=model),size=1) +
geom_line(data = whole_fe_elec_1 %>% filter(!model %in% c("India MARKAL","AIM/Enduse 3.0")), aes(x=period,y=value,group=interaction(model,scen_name),color=model,linetype=scen_name))+
    labs(
    x = "Year" ,
    y ="Final Energy by secotr (EJ/yr)",
    color = "Global Model",
    alpha="National Model",
    linetype = "Scenario Type")+
  theme_bw()+ 
  facet_grid(~variable)+
  coord_cartesian(xlim = c(2005,2050),ylim=c(0,15))+
  scale_colour_manual(values = myColors)+
  scale_alpha_discrete(range = c(0.95, 0.60))+
   scale_x_continuous(breaks=seq(2010, 2050, 20))+ # avoid overlap of axis labels
  facet_wrap(~variable, labeller = labeller(variable = label_wrap_gen(10))) # wrapping labels



```


### Transmission losses
```{r transmission loss,warning=FALSE,fig.show='hold',out.width="50%"}
#### DATA
whole_fe_elec <- whole_fe_elec %>% 
  arrange(model,scenario)
whole_se_elec_sum <- whole_se_elec_sum %>% 
  arrange(model,scenario)

whole_se_elec_eff <- transform(whole_se_elec_sum,efficiency=whole_fe_elec$value/whole_se_elec_sum$value) 


hist_elec_eff <- transform(hist_se_elec_sum,efficiency=hist_fe_elec$Value/Value)

#### PLOT
ggplot()+
  geom_line(data = whole_se_elec_eff %>% filter(model %in% c("India MARKAL","AIM/Enduse 3.0")), aes(x=period,y=efficiency,group=interaction(model,scen_name),linetype=scen_name,alpha=model)) +
geom_line(data = whole_se_elec_eff %>% filter(!model %in% c("India MARKAL","AIM/Enduse 3.0")), aes(x=period,y=efficiency,group=interaction(model,scen_name),color=model,linetype=scen_name))+
    labs(
    x = "Year" ,
    y = "Elec. Efficiency",
    color = "Global Model",
    alpha="National Model",
    linetype = "Scenario Type")+
  theme_bw()+
  coord_cartesian(xlim = c(2005,2050))+
  annotate(geom = "point",x =c(2005:2015),y=hist_elec_eff$efficiency)

```

### Capacity
#### Coal Capacity
```{r coal_plant_eff,warning=FALSE,fig.show='hold',out.width="50%"}

whole_coal_cap <- whole %>% filter(variable %in% c("Capacity|Electricity|Coal|w/o CCS","Capacity|Electricity|Coal|w/ CCS")) %>% group_by(region,unit,period,modscen,model_scope,scenario,model_scope,model,scen_name) %>% 
  summarise(value=sum(value)) %>% 
  mutate(variable="Capacity|Electricity|Coal")# name everything coal

 
# Current Capacity 
hist_coal_cap <- hist_and_botmup%>% filter(Region=="IND", Source =="EndCoal")
hist_coal_cap$Value <- hist_coal_cap$Value/1000 # MW to GW
# Historical Capacity- source http://www.indiaenergy.gov.in
hist_2 <- data.frame(energy=rep("coal",11),Year=c(2006:2016),value=c(77003.79,
80187.53,
84981.5,
89040.04,
99433.85,
111442.05,
132824.89,
152416.62,
168973.58,
189013.91,
184587
))

  # line_type_1(whole_coal_cap,hist_coal_cap)
line_type_2(whole_coal_cap,hist_coal_cap[hist_coal_cap$Variable=="Operating",])+
    annotate("point",y = hist_2$value/1000,x=hist_2$Year,color="red")+
      geom_hline(yintercept=hist_coal_cap[hist_coal_cap$Variable=="Operating",]$Value)+
        geom_text(x=2015,y=230,aes(label="Operating"),check_overlap = T)+
          geom_hline(yintercept =  hist_coal_cap[hist_coal_cap$Variable=="Operating",]$Value+hist_coal_cap[hist_coal_cap$Variable=="Construction",]$Value)+
            geom_text(x=2015,y=270,aes(label="Under Construction"),check_overlap = T)+
              geom_hline(yintercept = hist_coal_cap[hist_coal_cap$Variable=="Operating",]$Value+hist_coal_cap[hist_coal_cap$Variable=="Announced + Pre-permit + Permitted",]$Value)+
  geom_text(x=2015,y=300,aes(label="Under construction + planned"),check_overlap = T)

  

```

#### Cumulative Coal Capacity
```{r}
whole_coal_cap <- whole %>%  filter(variable=="Capacity|Electricity|Coal|w/o CCS" )
whole_coal_cap_add <- whole_coal_cap %>% 
  filter(period %in% c(2020,2030)) %>% 
  group_by(model,modscen,scen_name,model_scope) %>% 
  arrange(period) %>% 
  summarise(add=diff(value)) %>% 
  mutate(period="2020-2030")

  

# line_type_2(whole_coal_cap_add,hist_emi)


hist_coal_cap <- hist_and_botmup %>% filter(Source=="EndCoal",Region=="IND", Variable %in% c("Operating","Construction","Announced + Pre-permit + Permitted")) %>% 
  add_row(Variable="All future",Year=2018,Value=102699)
names(hist_coal_cap)[4] <- "variable"
names(hist_coal_cap)[5] <- "value"
hist_coal_cap$Value <- hist_coal_cap$value
  # mutate(new=Value[Variable=="Construction"]+Value[Variable=="Announced + Pre-permit + Permitted"])


ggplot()+
  geom_bar( data = hist_coal_cap %>% filter(!variable %in% c("Operating","All future")),aes(x = Year, y = value/1000,alpha=variable), stat="identity",width = 0.6)+
  geom_bar(data = whole_coal_cap_add %>% filter(period<2031),aes(x= scen_name,y= add,group=interaction(model,scen_name),fill=model),stat = "identity",position = "dodge",color="black")+scale_color_manual(values = myColors)+labs(
    y = " Coal capacity (GW)",
    x=""
  )+
  scale_alpha_discrete(range = c(0.95, 0.50))+ 
  scale_x_discrete(labels = function(variable) str_wrap(variable, width = 10))+theme_bw()



```  

#### Renewable Energy Capacity
```{r REN capcacity}

plotvar_1 <- c("Capacity|Electricity|Biomass|w/ CCS",
             "Capacity|Electricity|Biomass|w/o CCS",
              "Capacity|Electricity|Hydro",
              "Capacity|Electricity|Solar",
             "Capacity|Electricity|Wind",
             "Capacity|Electricity|Solar|PV",
             "Capacity|Electricity|Nuclear"
               )
#Power capacity in 2030
source("plotstyle.R")

whole_cap_elec <- whole[whole$variable %in% plotvar_1 & whole$period %in% c(2030,2050),]

whole_j <- whole[whole$period %in% c(2030,2050) & whole$variable %in% "Capacity|Electricity|Solar|PV" & whole$model %in% c("AIM V2.1","AIM/CGE","DNE21+ V.14", "REMIND-MAgPIE 1.7-3.0"),]

whole_j$variable <- "Capacity|Electricity|Solar"
whole_cap_elec <- rbind(whole_cap_elec,whole_j) %>% 
  filter(variable!="Capacity|Electricity|Solar|PV")


####### Capacity shares 
ggplot()+
  geom_bar(data=whole_cap_elec %>% filter(period %in%   c(2030),model_scope=="national"),aes(x=as.factor(period),y=value,group=variable,fill=variable),position = "fill",stat = "identity",color="red")+
  facet_grid(scen_name~model)+
    scale_fill_manual(values=plotstyle(plotvar_1))+
      theme(strip.text.x = element_text(angle = 90,size = 8),axis.text.x = element_text(angle = 90, hjust = 1))+
  labs(x="Period",
    y = "Installed capacity shares in 2030")+
    geom_bar(data=whole_cap_elec %>% filter(period %in% c(2030),model_scope=="global"),aes(x=as.factor(period),y=value,group=variable,fill=variable),position = "fill",stat = "identity")+
    scale_fill_manual(values=plotstyle(plotvar_1))+
  facet_grid(scen_name~model)

####### Absolute capacity
ggplot()+
  geom_bar(data=whole_cap_elec , aes(x=scen_name,y=value,group=variable,fill=variable),position = "stack",stat = "identity")+facet_grid(period~model)+
   scale_fill_manual(values=plotstyle(plotvar_1))+
      theme(strip.text.x = element_text(angle = 90,size = 8),axis.text.x = element_text(angle = 90, hjust = 1))
  

```


### Coal Plants
#### Efficiency of coal plants
```{r}

whole_pe_coal_elec <- whole %>%
                  filter(variable=="Primary Energy|Coal|Electricity", !modscen %in% c("AIM/Enduse 3.0 - INDC2030_low_V3" ,"AIM/Enduse 3.0 - NPi2020_low_V3"))%>% 
                  arrange(modscen)
whole_se_coal_elec <- whole %>% 
                      filter(variable %in% c("Secondary Energy|Electricity|Coal"),!model %in% c("COPPE-COFFEE 1.0")) %>%
                      arrange(modscen)

whole_se_coal_elec_eff <- transform(whole_se_coal_elec,efficiency=whole_se_coal_elec$value/whole_pe_coal_elec$value) %>% 
  filter(model!="MESSAGEix-GLOBIOM_1.0")
  

ggplot()+
  geom_line(data = whole_se_coal_elec_eff , aes(x=period,y=efficiency,group=interaction(model,scen_name),linetype=model_scope,color=model)) +
   labs(
    x = "Year" ,
    y = "Plant efficiency",
    color = "Model Scope",
    linetype = "Scenario Type"
  ) +
  theme_bw()+ 
  coord_cartesian(xlim = c(2005,2050))
  
```
#### Capacity Factor

```{r}
 # removing observations in whole_se_coal that are not in whole_cap_coal
#
whole_se_elec_coal_2 <- whole_se_elec_coal %>%
  filter(!modscen %in% c("COPPE-COFFEE 1.0 - NPi2020_1000_V3","COPPE-COFFEE 1.0 - INDC2030i_1000_V3")) %>% 
  arrange(modscen)


 whole_cap_factor <- whole_coal_cap %>%
  filter(!modscen %in% c("AIM/Enduse 3.0 - NPi2020_low_V3")) %>% 
    arrange(modscen)

 
whole_cap_factor$cap_factor = whole_se_elec_coal_2$value*277777.778/(whole_cap_factor$value*8760)   
whole_cap_factor <- whole_cap_factor %>% filter(value!=0)

ggplot()+
  geom_line(data = whole_cap_factor, aes(x=period,y=cap_factor,group=interaction(model,scen_name),linetype=scen_name,color=model)) +
   labs(
    x = "Year" ,
    y = "Capacity Factor",
    color = "Model Scope",
    linetype = "Scenario Type"
  ) +
  theme_bw()+
  coord_cartesian(xlim = c(2005,2050))

```



### Capital Costs
#### Capital Cost of Solar PV 
```{r capital cost solar,message=FALSE,warning=FALSE,error=FALSE,purl=FALSE}
#plot capital cost
plotvar <- c("Capital Cost|Electricity|Solar|PV","Capital Cost|Electricity|Solar")

#plotvar <- c("Capital Cost|Electricity|Coal|w/o CCS","Capital Cost|Electricity|Solar|PV" )
whole_cap_cost <- whole[whole$variable==plotvar,]
localrate = 0.02 #https://www.xe.com/currencycharts/?from=INR&to=USD&view=10Y
whole_cap_cost[whole_cap_cost$model %in% c("India MARKAL","AIM/Enduse 3.0"),]$value <- whole_cap_cost[whole_cap_cost$model %in% c("India MARKAL","AIM/Enduse 3.0"),]$value*localrate
proj_iea <- hist_and_botmup %>% filter(Region=="IND", Year %in% c(2015:2040),Variable =="spv",Source=="IEA_WEO") 

#line_type_1(whole_cap_cost,proj_iea)
line_type_2(whole_cap_cost,proj_iea)
```

#### Capital Cost of Wind onshore
```{r capital cost wind,message=FALSE,warning=FALSE,error=FALSE,purl=FALSE}
#plot capital cost
plotvar <- c("Capital Cost|Electricity|Wind|Onshore")
#plotvar <- c("Capital Cost|Electricity|Coal|w/o CCS","Capital Cost|Electricity|Solar|PV" )
whole_cap_cost <- whole[whole$variable==plotvar,]
localrate = 0.02 #https://www.xe.com/currencycharts/?from=INR&to=USD&view=10Y
whole_cap_cost[whole_cap_cost$model %in% c("India MARKAL","AIM/Enduse 3.0"),]$value <- whole_cap_cost[whole_cap_cost$model %in% c("India MARKAL","AIM/Enduse 3.0"),]$value*localrate
proj_iea <- hist_and_botmup %>% filter(Region=="IND", Year %in% c(2015:2040),Variable =="wind",Source=="IEA_WEO") 

#line_type_1(whole_cap_cost,proj_iea)
line_type_2(whole_cap_cost,proj_iea)
```







### Primary Energy Total
```{r}
#### DATA
whole_pe_fossil <- whole %>% filter(variable %in% c("Primary Energy|Coal|Electricity","Primary Energy|Gas|Electricity"))


hist_pe_tot <- hist_and_botmup %>% filter(Variable=="PE (EJ/yr)",Year %in% c(2005:2015),Region=="IND")
hist_pe_coal_elec <- hist_and_botmup %>% filter(Variable=="PE|Coal|Electricity (EJ/yr)",Year %in% c(2005:2015),Region=="IND")
hist_pe_gas_elec <- hist_and_botmup %>% filter(Variable=="PE|Gas|Electricity (EJ/yr)",Year %in% c(2005:2015),Region=="IND")

#### PLOTS

ggplot()+
  geom_line(data = whole %>% filter(variable == "Primary Energy",period<2050,!model %in% c("India MARKAL")), aes(x=period,y=value,group=interaction(model,scen_name),color=model))+facet_grid(variable~scen_name)+
 labs(
    x = "Year")+ theme_bw()+annotate("point",x=c(2005:2015),y=hist_pe_tot$Value)+
scale_color_manual(values = myColors)

```
#### Primary Energy Coal for Electricity
```{r}
ggplot()+
  geom_line(data = whole_pe_fossil %>% filter(period<2050,variable=="Primary Energy|Coal|Electricity") , aes(x=period,y=value,group=interaction(model,scen_name),linetype=model_scope,color=model))+facet_grid(variable~scen_name)+
 labs(
    x = "Year"
    )+ theme_bw()+
   annotate("point",x=c(2005:2015),y=hist_pe_coal_elec$Value)+scale_color_manual(values = myColors)
```

#### Primary Energy Gas for Electricity
```{r}
ggplot()+
  geom_line(data = whole_pe_fossil %>% filter(period<2050,variable=="Primary Energy|Gas|Electricity") , aes(x=period,y=value,group=interaction(model,scen_name),linetype=model_scope,color=model))+facet_grid(variable~scen_name)+
 labs(
    x = "Year")+ theme_bw()+
   annotate("point",x=c(2005:2015),y=hist_pe_gas_elec$Value)+scale_color_manual(values = myColors)
```



